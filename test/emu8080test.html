<html>
<script src="../8080.js"></script>

<script>

var test = 
":01000500C931\n"+
":10010000210C0131BD07CD5501C3C4014D494352F6\n"+
":100110004F434F534D204153534F4349415445534F\n"+
":1001200020383038302F383038352043505520446F\n"+
":100130004941474E4F535449432056455253494F26\n"+
":100140004E20312E30202028432920313938300DDF\n"+
":100150000A24C300007EFE24C8CD600123C35501DC\n"+
":10016000F5D5E55F0E02CD0500E1D1F1C9F5CD7DF4\n"+
":10017000015FCD6001F1CD81015FC360010F0F0F01\n"+
":100180000FE60FFE0AFA8A01C607C630C90D0A43F8\n"+
":100190005055204953204F5045524154494F4E41EC\n"+
":1001A0004C240D0A204350552048415320464149D4\n"+
":1001B0004C454421202020204552524F5220455882\n"+
":1001C00049543D2431BD07E600CACF01CDA206D275\n"+
":1001D000D501CDA206EADB01CDA206F2E101CDA256\n"+
":1001E00006C2F001DAF001E2F001FAF001C3F30116\n"+
":1001F000CDA206C606C2FB01CDA206DA0402E204C5\n"+
":1002000002F20702CDA206C670E20F02CDA206FAE4\n"+
":100210001802CA1802D21B02CDA206C681FA230216\n"+
":10022000CDA206CA2C02DA2C02E22F02CDA206C60B\n"+
":10023000FEDA3702CDA206CA4002E24002FA4302C9\n"+
":10024000CDA206FE00DA5B02CA5B02FEF5DA5B02B3\n"+
":10025000C25B02FEFFCA5B02DA5E02CDA206CE0AD4\n"+
":10026000CE0AFE0BCA6A02CDA206D60CD60FFEF04D\n"+
":10027000CA7602CDA206DEF1DE0EFEF0CA8202CD03\n"+
":10028000A206E655FE50CA8C02CDA206F63AFE7AC8\n"+
":10029000CA9602CDA206EE0FFE75CAA002CDA20636\n"+
":1002A000E600DCA206E4A206FCA206C4A206FE004A\n"+
":1002B000CAB602CDA206D677D4A206ECA206F4A254\n"+
":1002C00006CCA206FE89CACC02CDA206E6FFE4D97E\n"+
":1002D00002FED9CA3603CDA206E8C610ECE502C676\n"+
":1002E00002E0CDA206E0C620FCF102C604E8CDA2E1\n"+
":1002F00006F0C680F4FD02C680F8CDA206F8C6401E\n"+
":10030000D40903C640F0CDA206D8C68FDC1503D6AB\n"+
":1003100002D0CDA206D0C6F7C42103C6FED8CDA216\n"+
":1003200006C8C601CC2D03C6D0C0CDA206C0C647A4\n"+
":10033000FE47C8CDA2063E773C4704480D515A639C\n"+
":100340006C7D3D4F596B4550627C57146A4D0C6172\n"+
":100350004405587B5F1C4360244C6955157A67251A\n"+
":100360005442682C5D1D4B796F2D655C534A417872\n"+
":10037000FE77C4A206AF06010E0316071E0F261F46\n"+
":100380002E3F80818283848587FEF0C4A2069091EF\n"+
":1003900092939495FE78C4A20697C4A2063E8087E5\n"+
":1003A00006010E0216031E0426052E06880680800E\n"+
":1003B000808980808A80808B80808C80808D808006\n"+
":1003C0008FFE37C4A2063E808706019806FF8099FB\n"+
":1003D000809A809B809C809DFEE0C4A2063E808720\n"+
":1003E0009FFEFFC4A2063EFF06FE0EFC16EF1E7F18\n"+
":1003F00026F42EBFA7A1A2A3A4A5A7FE24C4A206EB\n"+
":10040000AF06010E0216041E0826102E20B0B1B24F\n"+
":10041000B3B4B5B7FE3FC4A2063E00268F2E4FA848\n"+
":10042000A9AAABACADFECFC4A206AFC4A2060644D7\n"+
":100430000E4516461E4726062EBF700600463E4451\n"+
":10044000B8C4A206721600563E46BAC4A206731E6F\n"+
":10045000005E3E47BBC4A2067426062EBF663E065B\n"+
":10046000BCC4A2067526062EBF6E3EBFBDC4A20642\n"+
":1004700026062EBF3E3277BEC4A20686FE64C4A204\n"+
":1004800006AF7EFE32C4A20626062EBF7E96C4A20A\n"+
":10049000063E80878EFE33C4A2063E80879EFECD38\n"+
":1004A000C4A206A6C4A2063E25B6FE37C4A206AE66\n"+
":1004B000FE05C4A2063655343586FE5AC4A206018E\n"+
":1004C000FF1211FF1221FF120313233E13B8C4A21F\n"+
":1004D00006BAC4A206BCC4A2063E00B9C4A206BBAA\n"+
":1004E000C4A206BDC4A2060B1B2B3E12B8C4A206B2\n"+
":1004F000BAC4A206BCC4A2063EFFB9C4A206BBC4CD\n"+
":10050000A206BDC4A20632BF06AF3ABF06FEFFC4B4\n"+
":10051000A2062ABD0622BF063ABD06473ABF06B864\n"+
":10052000C4A2063ABE06473AC006B8C4A2063EAA0E\n"+
":1005300032BF06444DAF0AFEAAC4A2063C023ABF2F\n"+
":1005400006FEABC4A2063E7732BF062ABD061100E6\n"+
":1005500000EBAF1AFE77C4A206AF8485C4A2063EA4\n"+
":10056000CC123ABF06FECC123ABF06FECCC4A2069D\n"+
":10057000217777293EEEBCC4A206BDC4A206215550\n"+
":100580005501FFFF093E55D4A206BCC4A2063E5445\n"+
":10059000BDC4A20621AAAA113333193EDDBCC4A2F0\n"+
":1005A00006BDC4A20637D4A2063FDCA2063EAA2F8F\n"+
":1005B000FE55C4A206B727FE55C4A2063E8887276B\n"+
":1005C000FE76C4A206AF3EAA27D4A206FE10C4A29D\n"+
":1005D00006AF3E9A27D4A206C4A206373E4207DCE5\n"+
":1005E000A20607D4A206FE09C4A2060FD4A2060FD3\n"+
":1005F000FE42C4A2061717D4A206FE08C4A2061F14\n"+
":100600001FDCA206FE02C4A20601341211AAAA210E\n"+
":100610005555AFC5D5E5F5010000110000210000DA\n"+
":100620003EC0C6F0F1E1D1C1DCA206C4A206E4A23C\n"+
":1006300006FCA2063E12B8C4A2063E34B9C4A20605\n"+
":100640003EAABAC4A206BBC4A2063E55BCC4A206BA\n"+
":10065000BDC4A2062100003922C40631C3063B3BBB\n"+
":10066000333B3E5532C1062F32C206C1B8C4A20682\n"+
":100670002FB9C4A20621C306F92133773B3BE33AE5\n"+
":10068000C206FE77C4A2063AC106FE33C4A2063EE5\n"+
":1006900055BDC4A2062FBCC4A2062AC406F921B4C3\n"+
":1006A00006E921A201CD5501E37CCD6D017DCD6D23\n"+
":0F06B00001C35201218D01CD5501C35201BF0677\n"+
"+:00000001FF";


var toHexN = function(n,d) {
    var s = n.toString(16);
    while (s.length <d) {s = '0'+s;}
    return s.toUpperCase();
};

var toHex2 = function(n) {return toHexN(n & 0xff,2);};
var toHex4 = function(n) {return toHexN(n & 0xffff,4);};

;(function(window){
	var RAM= [];
	var byteTo = function(addr,b) {
        RAM[addr] = b & 0xff;};
	var byteAt = function(addr) {
		//console.log(addr);
		return RAM[addr] || 0;};

	var hexLine = function(ln) {
		if (ln[0]!=':') return false;
		var len = parseInt(ln[1]+ln[2], 16);
		var start = parseInt(ln[3]+ln[4]+ln[5]+ln[6], 16);
		var typ = parseInt(ln[7]+ln[8], 16);
		if (typ==0) {
			for (i=0;i<len;i++) {
				RAM[start+i] = parseInt(ln[9+2*i]+ln[10+2*i], 16);
			}
		}
	}


	window.EMU = {
		CPU:null,
		init: function(cpu) {
			RAM = [];
			EMU.CPU = cpu;
			EMU.CPU.init(byteTo,byteAt, null, null, null);
		},
		readHex: function(hex){
			var hexlines = hex.split(/\n/);
			for(var i=0;i<hexlines.length;i++){
				hexLine(hexlines[i]);
			}
		},
		RAM: function(){return RAM;},
        INTERRUPT: function(vector) {
//            console.log(vector);
            EMU.CPU.interrupt(vector);

        },
        RESET: function() {
            EMU.CPU.init(byteTo,byteAt, null, portOut, portIn);
        },
		T:0,
		MEMDUMP:0,
		linemap:null
	}
})(window);

EMU.init(CPU8080);
EMU.CPU.set("PC",0x100);
EMU.readHex(test);
//go
var PC=0x0100;
EMU.CPU.set("PC", PC);
var max=100000;
var last = [];
while(max--) {
	EMU.CPU.steps(1);
	PC = EMU.CPU.status().pc;
	last.push(toHex4(PC));if (last.length>10) last.shift();
	if (PC == 0x06b7) {document.write("OK");	break;
}
	if (PC == 0x06a5) {document.write("ERR" + toHex4(PC)); document.write(last);	break;
}
	if (PC == 0) {document.write("000");break;}
}
</script>